<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>The Blister Packs Tool</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      /* Default (dark) palette fallback vars ‚Äì overridden by body[data-theme] */
      --bg: #0f172a;
      --text: #e5e7eb;
      --card-bg: #020617;
      --border: #1f2937;
      --muted: #9ca3af;
      --muted-strong: #d1d5db;
      --pill-border: #4b5563;
      --error-text: #fecaca;
      --table-row-border: #111827;
      --calendar-cell-bg: #020617;
      --calendar-muted-text: #9ca3af;
      --calendar-other-month-opacity: 0.35;
    }
  :root { --tab-hover-bg: rgba(56, 189, 248, 0.12); }

    /* Dark theme */
    body[data-theme="dark"] {
      --bg: #0f172a;
      --text: #e5e7eb;
      --card-bg: #020617;
      --border: #1f2937;
      --muted: #9ca3af;
      --muted-strong: #d1d5db;
      --pill-border: #4b5563;
      --error-text: #fecaca;
      --table-row-border: #111827;
      --calendar-cell-bg: #020617;
      --calendar-muted-text: #9ca3af;
      --calendar-other-month-opacity: 0.35;
    }

    /* Light theme */
    body[data-theme="light"] {
      --bg: #f3f4f6;
      --text: #111827;
      --card-bg: #ffffff;
      --border: #e5e7eb;
      --muted: #6b7280;
      --muted-strong: #4b5563;
      --pill-border: #9ca3af;
      --error-text: #b91c1c;
      --table-row-border: #e5e7eb;
      --calendar-cell-bg: #ffffff;
      --calendar-muted-text: #9ca3af;
      --calendar-other-month-opacity: 0.35;
    }

    body[data-theme="light"] { --tab-hover-bg: rgba(56, 189, 248, 0.10); }
    body[data-theme="dark"]  { --tab-hover-bg: rgba(56, 189, 248, 0.16); }

    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      padding: 0;
      background: var(--bg);
      color: var(--text);
      display: flex;
      justify-content: center;
      min-height: 100vh;
      position: relative;
    }

    .container {
      max-width: 1000px;
      width: 100%;
      padding: 24px 16px 40px;
      position: relative;
      z-index: 1;
    }

    .card {
      background: var(--card-bg);
      border-radius: 16px;
      padding: 24px 20px 28px;
      box-shadow: 0 20px 40px rgba(15, 23, 42, 0.6);
      border: 1px solid var(--border);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      align-items: flex-start;
      margin-bottom: 12px;
    }

    h1 {
      font-size: 1.6rem;
      margin: 0 0 4px;
      color: var(--text);
    }

    .subtitle {
      font-size: 0.9rem;
      color: var(--muted);
    }

    .theme-select-wrapper {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 4px;
      min-width: 150px;
    }

    .theme-label {
      font-size: 0.75rem;
      color: var(--muted);
    }

    .theme-select {
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 4px 10px;
      font-size: 0.8rem;
      background: transparent;
      color: var(--muted-strong);
    }

    .theme-select:focus {
      outline: none;
      border-color: #38bdf8;
      box-shadow: 0 0 0 1px #38bdf8;
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 6px;
      border-bottom: 1px solid var(--border);
      margin-bottom: 14px;
      margin-top: 4px;
      flex-wrap: wrap;
    }

    .tab-btn {
      border: none;
      background: transparent;
      padding: 6px 12px;
      font-size: 0.85rem;
      cursor: pointer;
      color: var(--muted);
      border-bottom: 2px solid transparent;
      border-radius: 0;
      box-shadow: none;
      margin-top: 0;
    }

    .tab-btn:hover {
      color: var(--muted-strong);
      background: var(--tab-hover-bg);
    }

    .tab-btn--active {
      color: var(--text);
      border-bottom-color: #38bdf8;
      font-weight: 600;
    }

    .tab-content { display: none; }
    .tab-content--active { display: block; }

    .section-title {
      font-size: 0.95rem;
      margin: 18px 0 8px;
      color: var(--text);
      font-weight: 600;
    }

    label {
      font-size: 0.85rem;
      color: var(--muted-strong);
      display: block;
      margin-bottom: 4px;
    }

    input[type="date"],
    select {
      width: 100%;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--card-bg);
      color: var(--text);
      font-size: 0.9rem;
    }

    input[type="date"]:focus,
    select:focus {
      outline: none;
      border-color: #38bdf8;
      box-shadow: 0 0 0 1px #38bdf8;
    }

    button {
      border-radius: 999px;
      border: none;
      padding: 8px 16px;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      margin-top: 16px;
      background: linear-gradient(135deg, #38bdf8, #6366f1);
      color: white;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 10px 20px rgba(56, 189, 248, 0.3);
    }

    button:hover { filter: brightness(1.07); transform: translateY(-0.5px); }
    button:active { transform: translateY(0); box-shadow: 0 4px 10px rgba(15, 23, 42, 0.6); }

    .primary-btn { margin-top: 12px; }

    .small { font-size: 0.72rem; color: var(--muted); margin-top: 6px; }
    .error { color: var(--error-text); font-size: 0.8rem; margin-top: 6px; }

    /* Dashboard */
    .dashboard {
      margin-top: 16px;
      border-radius: 12px;
      border: 1px solid var(--border);
      padding: 10px 10px 12px;
      background: var(--card-bg);
    }

    .dashboard-title-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
      flex-wrap: wrap;
    }

    .dashboard-title { font-size: 0.95rem; font-weight: 600; }

    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
      gap: 10px;
      margin-top: 4px;
    }

    .dashboard-card {
      border-radius: 10px;
      border: 1px solid var(--border);
      padding: 8px 9px;
      font-size: 0.78rem;
      background: rgba(148, 163, 184, 0.04);
    }

    .dashboard-card + .dashboard-card { margin-top: 0; }
    .dashboard-card-title { font-weight: 600; margin-bottom: 4px; }
    .dashboard-row { display: flex; justify-content: space-between; gap: 6px; margin-top: 2px; }
    .dashboard-label { color: var(--muted); }
    .dashboard-value { font-weight: 500; }
    .dashboard-count { font-size: 0.72rem; color: var(--muted); margin-top: 2px; }

    /* Main calendar */
    .calendar-wrapper {
      margin-top: 18px;
      border-radius: 12px;
      border: 1px solid var(--border);
      padding: 10px;
      background: var(--card-bg);
    }

    .calendar-header-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; gap: 8px; }
    .calendar-month-label { font-size: 0.95rem; font-weight: 600; }
    .calendar-nav { display: flex; gap: 6px; }

    .calendar-nav-btn {
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 4px 8px;
      font-size: 0.8rem;
      background: transparent;
      color: var(--muted-strong);
      cursor: pointer;
      box-shadow: none;
      margin-top: 0;
    }

    .calendar-nav-btn:hover { background: rgba(148, 163, 184, 0.1); }

    table.calendar { width: 100%; border-collapse: collapse; table-layout: fixed; font-size: 0.78rem; }
    .calendar thead th { padding: 4px 0; text-align: center; font-weight: 500; color: var(--calendar-muted-text); }
    .calendar td { border-radius: 8px; padding: 4px; vertical-align: top; }

    .calendar-cell { background: var(--calendar-cell-bg); border: 1px solid transparent; cursor: pointer; min-height: 44px; display: flex; flex-direction: column; justify-content: space-between; }
    .calendar-cell--today { border-color: #38bdf8; }
    .calendar-cell--other { opacity: var(--calendar-other-month-opacity); }
    .calendar-cell--selected { border-color: #6366f1; box-shadow: 0 0 0 1px rgba(99, 102, 241, 0.6); }

    .calendar-day-number { font-size: 0.76rem; text-align: right; }
    .calendar-dots { margin-top: 4px; display: flex; flex-wrap: wrap; gap: 2px; }
    .calendar-dot { width: 6px; height: 6px; border-radius: 999px; }
    .dot-weekly-launch { background: #38bdf8; }
    .dot-bi-launch { background: #a855f7; }
    .dot-monthly-launch { background: #f97316; }
    .dot-automation { background: #22c55e; }
    .dot-delivery { background: #eab308; }

    .calendar-legend { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 8px; font-size: 0.72rem; color: var(--muted); }
    .calendar-legend span { display: inline-flex; align-items: center; gap: 4px; }

    .calendar-details { margin-top: 10px; padding-top: 8px; border-top: 1px dashed var(--border); }
    .calendar-details-title { font-size: 0.82rem; font-weight: 600; margin-bottom: 4px; }
    .calendar-details-body { font-size: 0.78rem; color: var(--muted-strong); }
    .calendar-details-body ul { padding-left: 18px; margin: 4px 0; }

    /* Results */
    .results { margin-top: 20px; border-radius: 12px; border: 1px solid var(--border); padding: 12px 10px; background: var(--card-bg); }
    .results-title { font-size: 0.95rem; margin-bottom: 8px; font-weight: 600; }
    table.results-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
    .results-table th, .results-table td { padding: 8px 6px; text-align: left; border-bottom: 1px solid var(--table-row-border); }
    .results-table th { font-weight: 600; color: var(--muted); font-size: 0.78rem; }

    .status-pill { display: inline-flex; align-items: center; gap: 4px; padding: 3px 8px; border-radius: 999px; font-size: 0.7rem; border: 1px solid var(--pill-border); color: var(--text); }
    .status-today { border-color: #22c55e; background: rgba(34, 197, 94, 0.12); color: #bbf7d0; }
    .status-upcoming { border-color: #38bdf8; background: rgba(56, 189, 248, 0.12); color: #000000; }
    .status-past { border-color: #f97316; background: rgba(249, 115, 22, 0.12); color: #fed7aa; }

    /* Wizard */
    .wizard-card { margin-top: 8px; border-radius: 12px; border: 1px solid var(--border); padding: 10px 10px 12px; background: var(--card-bg); }
    .wizard-grid { display: grid; grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.3fr); gap: 14px; margin-top: 4px; }
    .wizard-section { font-size: 0.82rem; }
    .wizard-section-title { font-weight: 600; margin-bottom: 4px; }
    .wizard-row { margin-top: 8px; }
    .wizard-helper { font-size: 0.72rem; color: var(--muted); margin-top: 4px; }

    .wizard-output-card { border-radius: 10px; border: 1px solid var(--border); padding: 8px 9px; font-size: 0.78rem; background: rgba(148, 163, 184, 0.04); margin-bottom: 8px; }
    .wizard-output-title { font-weight: 600; margin-bottom: 4px; }
    .wizard-output-row { display: flex; justify-content: space-between; gap: 6px; margin-top: 2px; }
    .wizard-output-label { color: var(--muted); }
    .wizard-output-value { font-weight: 500; text-align: right; }

    .wizard-note-textarea { width: 100%; min-height: 110px; resize: vertical; margin-top: 4px; font-size: 0.78rem; line-height: 1.35; border-radius: 8px; border: 1px solid var(--border); background: var(--card-bg); color: var(--text); padding: 6px 8px; }

    .wizard-checklist { font-size: 0.78rem; margin-top: 6px; color: var(--muted-strong); }
    .wizard-checklist ul { padding-left: 18px; margin: 4px 0; }

    /* Patient mini calendar */
    .patient-calendar-card { border-radius: 10px; border: 1px solid var(--border); padding: 8px 9px 10px; font-size: 0.78rem; background: rgba(148, 163, 184, 0.04); margin-bottom: 8px; margin-top: 4px; }
    .patient-calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; gap: 6px; }
    .patient-calendar-title { font-weight: 600; }
    .patient-calendar-months { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 8px; margin-top: 4px; }
    .patient-calendar-wrapper { border-radius: 8px; border: 1px solid var(--border); padding: 4px 4px 6px; background: var(--calendar-cell-bg); }
    .patient-calendar-month-label { font-size: 0.8rem; font-weight: 600; margin-bottom: 2px; text-align: center; }
    table.patient-calendar { width: 100%; border-collapse: collapse; table-layout: fixed; font-size: 0.72rem; }
    .patient-calendar thead th { padding: 3px 0; text-align: center; font-weight: 500; color: var(--calendar-muted-text); }
    .patient-calendar td { border-radius: 6px; padding: 3px; vertical-align: top; }
    .patient-calendar-cell { background: var(--calendar-cell-bg); border: 1px solid transparent; min-height: 32px; display: flex; flex-direction: column; justify-content: space-between; }
    .patient-calendar-cell--other { opacity: var(--calendar-other-month-opacity); }
    .patient-calendar-day-number { font-size: 0.7rem; text-align: right; }
    .patient-calendar-dots { margin-top: 3px; display: flex; flex-wrap: wrap; gap: 2px; }
    .patient-cal-dot { width: 6px; height: 6px; border-radius: 999px; }
    .patient-cal-dot--start { background: #22c55e; }
    .patient-cal-dot--launch { background: #38bdf8; }
    .patient-cal-dot--auto { background: #0ea5e9; }
    .patient-cal-dot--delivery { background: #eab308; }
    .patient-cal-dot--bagging { background: #f97316; }
    .patient-calendar-legend { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 4px; font-size: 0.7rem; color: var(--muted); }
    .patient-calendar-legend-item { display: inline-flex; align-items: center; gap: 4px; }
    .patient-calendar-legend-dot { width: 7px; height: 7px; border-radius: 999px; }

    /* Bridge (Bill new Rx) note area tweaks */
    .bridge-note-status { font-size: 0.72rem; color: var(--muted); margin-top: 4px; }
    .bridge-copy-btn { border-radius: 999px; border: 1px solid var(--border); padding: 4px 10px; font-size: 0.78rem; background: transparent; color: var(--muted-strong); box-shadow: none; margin-top: 8px; }
    .bridge-copy-btn:hover { background: rgba(148, 163, 184, 0.1); }

    @media (max-width: 640px) {
      .patient-calendar-day-number { font-size: 0.68rem; }
      .patient-calendar { font-size: 0.68rem; }
      .patient-calendar-months { grid-template-columns: 1fr; }
    }

    /* Training tab */
    .training-card { margin-top: 8px; border-radius: 12px; border: 1px solid var(--border); padding: 10px 10px 12px; background: var(--card-bg); font-size: 0.92rem; }
    .training-intro { font-size: 0.82rem; color: var(--muted); }
    .accordion-controls { display: flex; justify-content: flex-end; gap: 8px; margin-top: 8px; }
    .accordion-ctrl-btn { border-radius: 999px; border: 1px solid var(--border); padding: 6px 12px; font-size: 0.8rem; background: transparent; color: var(--muted-strong); box-shadow: none; }
    .accordion-ctrl-btn:hover { background: rgba(148, 163, 184, 0.1); }

    .accordion { display: flex; flex-direction: column; gap: 8px; margin-top: 8px; }
    .accordion-item { border: 1px solid var(--border); border-radius: 10px; background: rgba(148, 163, 184, 0.04); overflow: hidden; }
    .accordion-header { display: flex; align-items: center; justify-content: space-between; gap: 8px; padding: 10px 12px; cursor: pointer; user-select: none; }
    .accordion-title { font-weight: 600; font-size: 0.95rem; }
    .accordion-caret { transition: transform 0.18s ease; font-size: 0.9rem; }
    .accordion-item.open .accordion-caret { transform: rotate(90deg); }
    .accordion-panel { display: none; padding: 8px 12px 12px; border-top: 1px dashed var(--border); font-size: 0.86rem; }
    .accordion-panel ul { padding-left: 18px; margin: 4px 0; }

    /* Quick Links tab */
    .links-card { margin-top: 8px; border-radius: 12px; border: 1px solid var(--border); padding: 10px 10px 14px; background: var(--card-bg); font-size: 0.82rem; }
    .links-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 12px;
      margin-top: 8px;
    }
    .links-subcard {
      border-radius: 10px;
      border: 1px solid var(--border);
      padding: 8px 9px;
      background: rgba(148, 163, 184, 0.04);
    }
    .links-title { font-weight: 600; margin-bottom: 4px; }
    .links-subtitle { font-weight: 600; margin-bottom: 4px; }
    .quick-link { display: inline-flex; align-items: center; gap: 6px; font-size: 0.8rem; color: #38bdf8; text-decoration: none; }
    .quick-link:hover { text-decoration: underline; }
    .quick-link-pill { display: inline-flex; align-items: center; gap: 5px; padding: 4px 9px; border-radius: 999px; border: 1px solid var(--border); font-size: 0.75rem; background: rgba(148, 163, 184, 0.06); }
    .quick-link-desc {
      font-size: 0.75rem;
      color: var(--muted);
      margin-top: 4px;
    }

    @media (max-width: 800px) { .wizard-grid { grid-template-columns: minmax(0, 1fr); } }
    @media (max-width: 640px) {
      .card { padding: 18px 14px 22px; }
      h1 { font-size: 1.3rem; }
      .calendar-day-number { font-size: 0.7rem; }
      .theme-select-wrapper { min-width: 0; }
    }
  /* === Style 2: Livelier particle field + glassier card (theme-aware) === */
:root { --card-glass-bg: rgba(2, 6, 23, 0.48); }
body[data-theme="light"] {
  --card-glass-bg: rgba(255, 255, 255, 0.58);
  --particle1: rgba(56,189,248,0.90);
  --particle2: rgba(99,102,241,0.85);
  --particle3: rgba(14,165,233,0.85);
  --particleLine: rgba(56,189,248,0.35);
}
body[data-theme="dark"]  {
  --card-glass-bg: rgba(2, 6, 23, 0.50);
  --particle1: rgba(56,189,248,0.85);
  --particle2: rgba(99,102,241,0.78);
  --particle3: rgba(14,165,233,0.78);
  --particleLine: rgba(99,102,241,0.28);
}

/* Fullscreen particle canvas */
#bgParticles{position:fixed;inset:0;z-index:0;display:block;background:transparent;pointer-events:none;} 

/* Make the main card a bit more glassy */
.card{background:var(--card-glass-bg)!important;-webkit-backdrop-filter:blur(16px) saturate(180%);backdrop-filter:blur(16px) saturate(180%);border-color: rgba(148,163,184,0.35);} 

/* Respect reduced motion */
@media (prefers-reduced-motion: reduce){
  #bgParticles{display:none;}
}

html{background:var(--bg);} 
</style>
</head>
<body data-theme="light">
  <canvas id="bgParticles" aria-hidden="true"></canvas>
  <div class="container">
    <div class="card">
      <div class="card-header">
        <div>
          <h1>The Blister Packs Tool</h1>
          <div class="small">Created by Ali Al-Dirawi (PharmD Student)</div>
        </div>
        <div class="theme-select-wrapper">
          <span class="theme-label">Theme</span>
          <select id="themeSelect" class="theme-select">
            <option value="light">Light</option>
            <option value="dark">Dark</option>
          </select>
        </div>
      </div>

      <!-- Tabs -->
      <div class="tabs">
        <button class="tab-btn tab-btn--active" data-tab-target="schedule">Schedule</button>
        <button class="tab-btn" data-tab-target="new-patient">New blister patient</button>
        <button class="tab-btn" data-tab-target="bill-rx">Bill New RX</button>
        <button class="tab-btn" data-tab-target="training">Training</button>
        <button class="tab-btn" data-tab-target="quick-links">Quick Links Hub</button>
      </div>

      <!-- TAB: Schedule -->
      <div id="tab-schedule" class="tab-content tab-content--active">
        <!-- 1. Today's date + Today button -->
        <div>
          <div class="section-title">1. Pick today‚Äôs date</div>
          <label for="todayInput">Today‚Äôs date</label>
          <div style="display: flex; gap: 8px; align-items: center; max-width: 280px;">
            <input type="date" id="todayInput" style="flex: 1;" />
            <button type="button" id="todayBtn" class="calendar-nav-btn" style="margin-top: 0;">
              Today
            </button>
          </div>
          <div class="small">
            This is usually today, but you can choose a future date if you are pre-planning.
          </div>
        </div>

        <button id="calcBtn" class="primary-btn">
          <span>Calculate next launch dates</span>
          <span>üßÆ</span>
        </button>
        <div id="errorBox" class="error" style="display:none;"></div>

        <!-- 2. Weekly dashboard -->
        <div class="dashboard" id="dashboardBox" style="display:none;">
          <div class="dashboard-title-row">
            <div class="dashboard-title">2. Weekly dashboard ‚Äì launches & automations</div>
          </div>
          <div class="small">
            Shows the next launch and automation dates for each batch based on the selected ‚Äútoday‚Äù.
          </div>
          <div class="dashboard-grid" id="dashboardBody"><!-- Filled by JS --></div>
        </div>

        <!-- 3. Calendar view -->
        <div class="section-title" style="margin-top: 20px;">3. Calendar view</div>
        <div class="calendar-wrapper">
          <div class="calendar-header-bar">
            <div class="calendar-month-label" id="calendarMonthLabel">Month Year</div>
            <div class="calendar-nav">
              <button type="button" id="prevMonthBtn" class="calendar-nav-btn">‚óÄ</button>
              <button type="button" id="nextMonthBtn" class="calendar-nav-btn">‚ñ∂</button>
            </div>
          </div>
          <table class="calendar">
            <thead>
              <tr>
                <th>Sun</th>
                <th>Mon</th>
                <th>Tue</th>
                <th>Wed</th>
                <th>Thu</th>
                <th>Fri</th>
                <th>Sat</th>
              </tr>
            </thead>
            <tbody id="calendarBody"><!-- Filled by JS --></tbody>
          </table>
          <div class="calendar-legend">
            <span><span class="calendar-dot dot-weekly-launch"></span> Weekly launch</span>
            <span><span class="calendar-dot dot-bi-launch"></span> Bi-weekly launch</span>
            <span><span class="calendar-dot dot-monthly-launch"></span> 28-day ‚Äúmonthly‚Äù launch</span>
            <span><span class="calendar-dot dot-automation"></span> Automation day</span>
            <span><span class="calendar-dot dot-delivery"></span> Delivery day</span>
          </div>
          <div class="calendar-details" id="calendarDetails">
            <div class="calendar-details-title">Day details</div>
            <div class="calendar-details-body">
              Select a date in the calendar to see all launches, automations, and deliveries on that day.
            </div>
          </div>
        </div>

        <!-- 4. Results table -->
        <div class="results" id="resultsBox" style="display:none;">
          <div class="results-title">4. Next launch dates</div>
          <table class="results-table">
            <thead>
              <tr>
                <th>Batch</th>
                <th>Next launch date</th>
                <th>Day of week</th>
                <th>Days until launch</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="resultsTableBody"><!-- Filled by JS --></tbody>
          </table>
          <div class="small" style="margin-top:6px;">
            ISP report:
            <a href="http://isp:6777/login" target="_blank" rel="noopener noreferrer">isp:6777/login</a>
          </div>
        </div>
      </div>

      <!-- TAB: New blister patient -->
      <div id="tab-new-patient" class="tab-content">
        <div class="section-title">New blister pack patient wizard</div>
        <div class="small">
          Use this wizard when a brand-new blister patient is added. It helps you plan bridge blister (if needed),
          first CPAK cycle timing, a copy-ready HealthWATCH note, a MAR setup checklist, and a mini calendar showing
          the patient‚Äôs start, launch, automation, CPAK delivery, and bagging dates.
        </div>

        <div class="wizard-card">
          <div class="wizard-grid">
            <!-- Left: inputs -->
            <div class="wizard-section">
              <div class="wizard-section-title">1. Patient & batch details</div>
              <div class="wizard-row">
                <label for="wizardBatchType">Batch type</label>
                <select id="wizardBatchType">
                  <option value="">Select...</option>
                  <option value="tue-weekly">Weekly ‚Äì Tuesday batch</option>
                  <option value="wed-weekly">Weekly ‚Äì Wednesday batch</option>
                  <option value="biweekly">Bi-weekly batch</option>
                  <option value="monthly">28-day ‚Äúmonthly‚Äù batch</option>
                </select>
                <div class="wizard-helper">
                  Choose which SS-CPAK-7 batch the patient will belong to (Tuesday, Wednesday, Bi-weekly, Monthly).
                </div>
              </div>

              <div class="wizard-row" style="margin-top:10px;">
                <label for="wizardStartDate">Patient start date</label>
                <input type="date" id="wizardStartDate" />
                <div class="wizard-helper">
                  This is the date the patient is first set up for blister packs at the pharmacy.
                </div>
              </div>

              <div class="wizard-row" style="margin-top:10px;">
                <label for="wizardHasSupply">Does the patient have enough supply at home?</label>
                <select id="wizardHasSupply">
                  <option value="">Select...</option>
                  <option value="yes">Yes ‚Äì they have enough supply until the next cycle</option>
                  <option value="no">No ‚Äì they have little or no supply at home</option>
                </select>
                <div class="wizard-helper">
                  If ‚ÄúNo‚Äù, the wizard will recommend a non-billed bridge blister until their CPAK blister is bagged and
                  ready for pickup.
                </div>
              </div>

              <button id="wizardGenerateBtn" class="primary-btn">
                <span>Generate plan</span>
                <span>‚ú®</span>
              </button>
              <div id="wizardErrorBox" class="error" style="display:none;"></div>
            </div>

            <!-- Right: output -->
            <div class="wizard-section">
              <div class="wizard-section-title">Plan & documentation</div>
              <div id="wizardOutputBox" style="display:none;">
                <div class="wizard-output-card">
                  <div class="wizard-output-title">Summary</div>
                  <div class="wizard-output-row">
                    <span class="wizard-output-label">Batch</span>
                    <span class="wizard-output-value" id="wizardSummaryBatch">‚Äî</span>
                  </div>
                  <div class="wizard-output-row">
                    <span class="wizard-output-label">Start date</span>
                    <span class="wizard-output-value" id="wizardSummaryStartDate">‚Äî</span>
                  </div>
                  <div class="wizard-output-row">
                    <span class="wizard-output-label">First launch (Sunday)</span>
                    <span class="wizard-output-value" id="wizardSummaryLaunchDate">‚Äî</span>
                  </div>
                  <div class="wizard-output-row">
                    <span class="wizard-output-label">Bridge blister</span>
                    <span class="wizard-output-value" id="wizardSummaryBridge">‚Äî</span>
                  </div>
                  <div class="wizard-output-row">
                    <span class="wizard-output-label">Automation (Wednesday)</span>
                    <span class="wizard-output-value" id="wizardSummaryAutomation">‚Äî</span>
                  </div>
                  <div class="wizard-output-row">
                    <span class="wizard-output-label">CPAK delivery (Monday)</span>
                    <span class="wizard-output-value" id="wizardSummaryDelivery">‚Äî</span>
                  </div>
                  <div class="wizard-output-row">
                    <span class="wizard-output-label">Bagging/pick-up (Sunday)</span>
                    <span class="wizard-output-value" id="wizardSummaryBagging">‚Äî</span>
                  </div>
                </div>

                <!-- Patient mini calendar (1 or 2 months) -->
                <div class="patient-calendar-card" id="wizardCalCard" style="display:none;">
                  <div class="patient-calendar-header">
                    <div class="patient-calendar-title">Calendar for this patient</div>
                  </div>
                  <div class="patient-calendar-months" id="wizardCalMonthsContainer"><!-- Filled by JS --></div>
                  <div class="patient-calendar-legend">
                    <span class="patient-calendar-legend-item">
                      <span class="patient-calendar-legend-dot" style="background:#22c55e;"></span>
                      Start
                    </span>
                    <span class="patient-calendar-legend-item">
                      <span class="patient-calendar-legend-dot" style="background:#38bdf8;"></span>
                      First launch (Sunday)
                    </span>
                    <span class="patient-calendar-legend-item">
                      <span class="patient-calendar-legend-dot" style="background:#0ea5e9;"></span>
                      Automation (Wednesday)
                    </span>
                    <span class="patient-calendar-legend-item">
                      <span class="patient-calendar-legend-dot" style="background:#eab308;"></span>
                      CPAK delivery (Monday)
                    </span>
                    <span class="patient-calendar-legend-item">
                      <span class="patient-calendar-legend-dot" style="background:#f97316;"></span>
                      Bagging / ready (Sunday)
                    </span>
                  </div>
                  <div class="wizard-helper" style="margin-top:4px;">
                    This mini calendar shows the patient‚Äôs start date and their first blister cycle: launch, automation,
                    CPAK delivery, and bagging/pick-up. If the cycle spans two different months, both months are shown
                    side-by-side.
                  </div>
                </div>

                <div class="wizard-output-card">
                  <div class="wizard-output-title">HealthWATCH note (copy-ready)</div>
                  <textarea id="wizardNoteText" class="wizard-note-textarea" readonly></textarea>
                  <div class="wizard-helper">Copy and paste into the patient‚Äôs profile note in HealthWATCH. Adjust wording as needed.</div>
                </div>

                <div class="wizard-output-card wizard-checklist">
                  <div class="wizard-output-title">MAR & batch setup checklist</div>
                  <ul>
                    <li>Assign Group: <strong>SS-CPAK-7</strong> and select the correct batch (Tuesday, Wednesday, Bi-weekly, or Monthly).</li>
                    <li>Re-log all active prescriptions and print each prescription form; confirm quantities match 7/14/28-day multiples.</li>
                    <li>Update Group/Packaging Info: include in batch = Yes; Packaging type = Shared Services CPAK; assign card number.</li>
                    <li>Assign each medication to the correct slots (AM/Noon/PM/HS) with correct tablet counts or fractions.</li>
                    <li>Print the MAR (including logs), file it in the correct batch binder with a Change Log sheet.</li>
                  </ul>
                </div>
              </div>

              <div id="wizardPlaceholder" class="wizard-helper">
                Fill out the batch type, patient start date, and supply at home, then click ‚ÄúGenerate plan‚Äù to see
                bridge blister needs, first CPAK cycle, a patient-specific calendar, and documentation prompts.
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- TAB: Bill new Rx (bridge) -->
      <div id="tab-bill-rx" class="tab-content">
        <div class="section-title">Bill New RX</div>
        <div class="small">
          Use this when an existing blister-pack patient gets a new Rx or dose change mid-cycle. The tool will calculate:
          <strong>quantity</strong> to bill, <strong>days supply</strong> (from today until the next launch Sunday),
          and a copy-ready note for the supplemental notes.
        </div>

        <div class="wizard-card">
          <div class="wizard-grid">
            <!-- Left: inputs -->
            <div class="wizard-section">
              <div class="wizard-section-title">1. Rx & batch details</div>

              <div class="wizard-row">
                <label for="bridgeBatchType">Batch type</label>
                <select id="bridgeBatchType">
                  <option value="weekly">Weekly batch</option>
                  <option value="biweekly">Bi-weekly batch</option>
                  <option value="monthly">28-day ‚Äúmonthly‚Äù batch</option>
                </select>
                <div class="wizard-helper">For the patient‚Äôs existing SS-CPAK-7 batch (weekly, bi-weekly, or 28-day monthly).</div>
              </div>

              <div class="wizard-row" style="margin-top:10px;">
                <label for="bridgeTodayDate">Today‚Äôs date / Rx billed date</label>
                <input type="date" id="bridgeTodayDate" />
                <div class="wizard-helper">Date you are billing the new prescription or dose change.</div>
              </div>

              <div class="wizard-row" style="margin-top:10px;">
                <label for="bridgeNextLaunch">Next launch (Sunday) for this batch</label>
                <input type="date" id="bridgeNextLaunch" />
                <div class="wizard-helper">Launch Sunday when this change will enter CPAK. Days supply will be ‚Äúfrom today until this Sunday‚Äù.</div>
              </div>

              <div class="wizard-row" style="margin-top:10px;">
                <label for="bridgeTabsPerDay">Tablets per day</label>
                <input type="number" id="bridgeTabsPerDay" step="0.25" min="0" />
                <div class="wizard-helper">Example: OD = 1, BID = 2, 1.5 tabs/day = 1.5.</div>
              </div>

              <div class="wizard-row" style="margin-top:10px;">
                <label for="bridgeHasOnHand">Is there already a CPAK blister in the pharmacy for this patient?</label>
                <select id="bridgeHasOnHand">
                  <option value="no" selected>No</option>
                  <option value="yes">Yes</option>
                </select>
                <div class="wizard-helper">If <strong>Yes</strong>, quantity will cover <strong>3 weeks (21 days)</strong> of doses to account for the blister on hand and the next two blisters until the change arrives.</div>
              </div>

              <div class="wizard-row" style="margin-top:10px;">
                <label for="bridgeDrugName">Drug name / strength (for note)</label>
                <input type="text" id="bridgeDrugName" placeholder="e.g., Rosuvastatin 20 mg" />
              </div>

              <button id="bridgeCalcBtn" class="primary-btn">
                <span>Calculate bridge quantity & days supply</span>
                <span>üíä</span>
              </button>
              <div id="bridgeErrorBox" class="error" style="display:none;"></div>
            </div>

            <!-- Right: output -->
            <div class="wizard-section">
              <div class="wizard-section-title">Bridge output</div>
              <div id="bridgeOutputBox" class="wizard-helper">
                Enter the details on the left and click <strong>‚ÄúCalculate bridge quantity & days supply‚Äù</strong>. The tool will:
                <ul style="margin-top:4px; padding-left:18px;">
                  <li>Assume the CPAK blister with this change will be <strong>ready for pickup 14 days after the launch Sunday</strong>.</li>
                  <li>Calculate the <strong>quantity</strong> as: <em>tablets per day √ó days from today until the CPAK blister is ready</em>.</li>
                  <li>Set <strong>days supply</strong> as: <em>number of days from today until the next launch Sunday</em> (your ‚Äúfrom now until launch‚Äù rule).</li>
                  <li>Generate a <strong>copy-ready note</strong> for patient supplemental notes.</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- TAB: Training -->
      <div id="tab-training" class="tab-content">
        <div class="section-title">Training ‚Äì blister pack workflow refresher</div>
        <div class="small training-intro">
          This tab mirrors the Blister Pack Guide. Click a task to expand its steps. Use the controls to open/close all. State is remembered per browser.
        </div>

        <div class="training-card">
          <div class="accordion-controls">
            <button type="button" id="accExpandAll" class="accordion-ctrl-btn">Expand all</button>
            <button type="button" id="accCollapseAll" class="accordion-ctrl-btn">Collapse all</button>
          </div>

          <div id="trainingAccordion" class="accordion">
            <!-- 1. Big picture -->
            <div class="accordion-item" data-id="1">
              <div class="accordion-header"><div class="accordion-title">1. Big picture ‚Äì SS-CPAK-7 workflow</div><div class="accordion-caret">‚ñ∂</div></div>
              <div class="accordion-panel">
                <p style="margin:4px 0 6px;">All blister pack patients at the store are under one group: <strong>SS-CPAK-7</strong>. Within that group, you have four cycles: Tuesday, Wednesday, Bi-weekly, and 28-day ‚ÄúMonthly‚Äù.</p>
                <ul>
                  <li>Each batch follows the same sequence: <strong>Launch ‚Üí Automation ‚Üí CPAK shipment ‚Üí Cross-check/fix ‚Üí Product check ‚Üí Bagging</strong>.</li>
                  <li><strong>Launch day:</strong> Sunday for all batches (Tue/Wed/Bi-weekly/Monthly).</li>
                  <li><strong>CPAK delivery:</strong> Monday of the following week for the last automation sent.</li>
                  <li><strong>Work-on-blisters day:</strong> Wednesday ‚Äì cross-check against MAR and fix.</li>
                  <li><strong>Product check:</strong> Usually Saturday for fixed packs.</li>
                  <li><strong>Bagging & sorting:</strong> Sunday ‚Äì bag and sort for pickup or delivery.</li>
                </ul>
              </div>
            </div>

            <!-- 2. Launching the batch -->
            <div class="accordion-item" data-id="2">
              <div class="accordion-header"><div class="accordion-title">2. Launching the batch (Section 6)</div><div class="accordion-caret">‚ñ∂</div></div>
              <div class="accordion-panel">
                <p style="margin:4px 0 6px;">Launching the batch tells HealthWATCH: ‚ÄúRefill everything in this batch now.‚Äù This is what starts the entire CPAK cycle.</p>
                <ul>
                  <li>When you launch:
                    <ul>
                      <li>All RXs in that batch are refilled.</li>
                      <li>RXs needing adjudication go to the <strong>batch adjudication queue</strong>.</li>
                      <li>RXs with no refills go to the <strong>batch reauthorization queue</strong>.</li>
                      <li>Once cleared, RXs sit in the <strong>DV/CV batch queue</strong> for pharmacist check.</li>
                    </ul>
                  </li>
                  <li>Quick HealthWATCH flow:
                    <ul>
                      <li>ACTIONS ‚Üí <strong>Launch/View Batch</strong>.</li>
                      <li>Select <strong>Group = SS-CPAK-7</strong>, then choose the right batch (Tue/Wed/Bi-weekly/Monthly).</li>
                      <li>Select today‚Äôs date and <strong>waive total fee</strong> and <strong>fee variance</strong> if needed.</li>
                      <li>Launch the batch and then work through adjudication, reauthorization, and DV/CV queues.</li>
                    </ul>
                  </li>
                  <li>After queues are cleared and everything is billed, you use the <strong>ISP report</strong> to:
                    <ul>
                      <li>Confirm all claims billed properly.</li>
                      <li>Identify non-DSPs that need to be changed to CPAK DSP products.</li>
                      <li>Check if any patient is paying too much (insurance issues).</li>
                    </ul>
                  </li>
                </ul>
              </div>
            </div>

            <!-- 3. ISP report & DSP -->
            <div class="accordion-item" data-id="3">
              <div class="accordion-header"><div class="accordion-title">3. ISP report & DSP check (Section 6.5)</div><div class="accordion-caret">‚ñ∂</div></div>
              <div class="accordion-panel">
                <p style="margin:4px 0 6px;">The ISP report is your ‚Äúquality-control screenshot‚Äù for the batch after launch.</p>
                <ul>
                  <li><strong>Purpose:</strong>
                    <ul>
                      <li>Summarizes all TXs in the launched batch.</li>
                      <li>Shows which drugs are <strong>non-DSP</strong> so you can swap to CPAK-approved products.</li>
                      <li>Confirms claims that were billed successfully to insurance.</li>
                    </ul>
                  </li>
                  <li><strong>How to access:</strong>
                    <ul>
                      <li>Go to <strong>isp:6777/login</strong> (link is also on the Schedule tab).</li>
                      <li>Log in with HealthWATCH credentials.</li>
                      <li>Select <strong>Pre-Verification Batch Report</strong>.</li>
                      <li>Pick group <strong>SS-CPAK-7</strong> and set start/end dates to the batch launch date.</li>
                    </ul>
                  </li>
                  <li><strong>What to do with it:</strong>
                    <ul>
                      <li>Change any non-DSP drugs to CPAK‚Äôs DSP (using the CPAK e-formulary).</li>
                      <li>Scroll to the bottom and make sure each claim has a reasonable third-party payment.</li>
                      <li>If patient is paying a lot or $0 is paid by third party when it shouldn‚Äôt be, investigate.</li>
                    </ul>
                  </li>
                </ul>
              </div>
            </div>

            <!-- 4. Sending automation -->
            <div class="accordion-item" data-id="4">
              <div class="accordion-header"><div class="accordion-title">4. Sending automation (Section 8)</div><div class="accordion-caret">‚ñ∂</div></div>
              <div class="accordion-panel">
                <p style="margin:4px 0 6px;">Automation is how you tell CPAK: ‚ÄúHere are the prescriptions and dates ‚Äì please build blisters.‚Äù</p>
                <ul>
                  <li><strong>When:</strong> Every Wednesday, after:
                    <ul>
                      <li>Adjudication, reauthorization, and DV/CV queues are cleared for that batch.</li>
                      <li>ISP report issues are fixed.</li>
                    </ul>
                  </li>
                  <li><strong>HealthWATCH steps (ACTIONS ‚Üí Automation):</strong>
                    <ul>
                      <li>Device: <strong>SHARED SERVICES CPAK</strong>.</li>
                      <li>Group: <strong>SS-CPAK-7</strong>.</li>
                      <li>Sub-location: choose the batch (Tue, Wed, Bi-weekly, Monthly).</li>
                      <li>Start date: the <strong>Monday</strong> when CPAK will ship blisters to you.</li>
                      <li># of days: 7 (Tue/Wed), 14 (Bi-weekly), 28 (Monthly).</li>
                      <li>Tab through to auto-fill stop date, or count manually if needed.</li>
                      <li>Click ACTION ‚Üí <strong>Automate</strong>, and confirm status goes to COMPLETE.</li>
                    </ul>
                  </li>
                  <li><strong>Emailing CPAK:</strong>
                    <ul>
                      <li>Automation alone is not enough ‚Äî you must send the email with card & TX counts.</li>
                      <li>Use the EBC order confirmation template from PSDM email.</li>
                      <li>Fill in each batch name, card count, and number of TXs (from CPAK batch summary).</li>
                      <li>Send to the CPAK email and ensure you get a confirmation; follow-up if none arrives.</li>
                    </ul>
                  </li>
                </ul>
              </div>
            </div>

            <!-- 5. Receiving & cross-check -->
            <div class="accordion-item" data-id="5">
              <div class="accordion-header"><div class="accordion-title">5. Receiving CPAK & cross-checking (Section 9)</div><div class="accordion-caret">‚ñ∂</div></div>
              <div class="accordion-panel">
                <p style="margin:4px 0 6px;">Monday is ‚Äúarrivals‚Äù, Wednesday is ‚Äúwork day‚Äù for those blisters.</p>
                <ul>
                  <li><strong>Monday ‚Äì receiving:</strong>
                    <ul>
                      <li>CPAK ships packs for all batches that were automated previously.</li>
                      <li>Each batch arrives in its own box, alphabetically organized.</li>
                      <li>Boxes are stored in the office until cross-checking day.</li>
                    </ul>
                  </li>
                  <li><strong>Wednesday ‚Äì cross-check with MAR:</strong>
                    <ul>
                      <li>Organize blisters by batch and alphabetically by patient.</li>
                      <li>Pull out the MAR binders and match each blister to its MAR.</li>
                      <li>Check: correct meds, strengths, directions, time slots, and doses.</li>
                      <li>Remember CPAK may not pack: controlled meds, some vitamins, some brands, and non-DSPs ‚Äî these appear in red on the MAR and need to be added manually.</li>
                      <li>Use sticky notes on blisters that need fixing so nothing is missed.</li>
                    </ul>
                  </li>
                </ul>
              </div>
            </div>

            <!-- 6. Bagging & sorting -->
            <div class="accordion-item" data-id="6">
              <div class="accordion-header"><div class="accordion-title">6. Bagging & sorting for pick-up/delivery (Section 7)</div><div class="accordion-caret">‚ñ∂</div></div>
              <div class="accordion-panel">
                <p style="margin:4px 0 6px;">Once packs are checked and fixed, they are ready to be sent to patients ‚Äì but only if they are bagged and sorted properly.</p>
                <ul>
                  <li>Bag by batch:
                    <ul>
                      <li>Work on one batch at a time (e.g., Tuesday box, then Wednesday, etc.).</li>
                      <li>Lay out blisters alphabetically on the counter, then start bagging.</li>
                    </ul>
                  </li>
                  <li>Delivery vs pickup:
                    <ul>
                      <li>Use the <strong>delivery binder</strong> (by day of week) to identify who is for delivery.</li>
                      <li>Place delivery blisters into the appropriate delivery drawer/section by day.</li>
                      <li>Place the rest in pickup drawers alphabetically.</li>
                    </ul>
                  </li>
                  <li>Key reminders:
                    <ul>
                      <li>Remove any <strong>previous-week blisters</strong> from the pickup drawer before placing new ones.</li>
                      <li>Investigate blisters that were not picked up the previous week.</li>
                      <li>Report missing or damaged blisters in the blister pack group chat.</li>
                    </ul>
                  </li>
                </ul>
              </div>
            </div>

            <!-- 7. New patient setup & MAR -->
            <div class="accordion-item" data-id="7">
              <div class="accordion-header"><div class="accordion-title">7. New blister patient setup & MAR (Section 5)</div><div class="accordion-caret">‚ñ∂</div></div>
              <div class="accordion-panel">
                <p style="margin:4px 0 6px;">Section 5 of the guide explains the full process. This item is the ‚Äúfast memory hook‚Äù that pairs with the tool‚Äôs New blister patient tab.</p>
                <ul>
                  <li><strong>Pharmacist piece (before setup):</strong>
                    <ul>
                      <li>Do a medication review & pick time slots (AM/Noon/PM/HS).</li>
                      <li>Complete and fax the <strong>Frequent Dispensing Form</strong> to the prescriber.</li>
                      <li>Help patient choose the most appropriate batch (often Bi-weekly).</li>
                      <li>Text the blister pack WhatsApp group: name, batch, pickup/delivery day, and who is setting it up.</li>
                    </ul>
                  </li>
                  <li><strong>HealthWATCH setup:</strong>
                    <ul>
                      <li>Assign <strong>Group = SS-CPAK-7</strong> and choose the correct Sub-location.</li>
                      <li>Scan/enter all prescriptions for the blister pack.</li>
                      <li>Ensure quantities & days‚Äô supply match the cycle: 7, 14, or 28 days.</li>
                      <li>In <strong>Group/Pkg info</strong>: Include in batch = Yes, Packaging = Shared Services CPAK, assign a card number, and assign each medication to the right slots.</li>
                      <li>Log the RX once everything is set up correctly.</li>
                    </ul>
                  </li>
                  <li><strong>Creating & filing the MAR:</strong>
                    <ul>
                      <li>Go: Home ‚Üí Maintenance ‚Üí Reports ‚Üí Compliance Pack Label.</li>
                      <li>Group = SS-CPAK-7, Sort order = Trade name, Include logs = Yes.</li>
                      <li>Search for the patient and print the MAR.</li>
                      <li>Have the MAR signed (ideally) by the pharmacist who did the review.</li>
                      <li>File the MAR in the correct batch binder and attach a Change Log sheet.</li>
                    </ul>
                  </li>
                </ul>
              </div>
            </div>

            <!-- 8. Bridge blisters & timing -->
            <div class="accordion-item" data-id="8">
              <div class="accordion-header"><div class="accordion-title">8. Bridge blisters & timing examples</div><div class="accordion-caret">‚ñ∂</div></div>
              <div class="accordion-panel">
                <p style="margin:4px 0 6px;">Bridge blisters are for when a patient starts or changes mid-cycle and CPAK hasn‚Äôt caught up yet. The idea: give them enough tablets to ‚Äúbridge‚Äù until the CPAK blister that reflects the change is bagged and ready.</p>
                <ul>
                  <li><strong>Concept:</strong>
                    <ul>
                      <li>Bridge covers from the <strong>setup/change date</strong> until the CPAK blister is <strong>bagged and ready for pick-up</strong>.</li>
                      <li>You often bill a larger quantity but enter a smaller days supply in HealthWATCH to line up with the next launch and avoid early refill rejections.</li>
                    </ul>
                  </li>
                  <li><strong>Documentation style (examples from guide):</strong>
                    <ul>
                      <li>Note that a bridge was given to cover until a specific CPAK date.</li>
                      <li>Explain that days‚Äô supply was adjusted for billing but the patient still received the full clinical supply.</li>
                      <li>Text the blister pack group chat so that, before the next launch, the RX is adjusted back to the normal 7/14/28-day quantity.</li>
                    </ul>
                  </li>
                  <li><strong>In this tool:</strong>
                    <ul>
                      <li>The <strong>New blister patient wizard</strong> uses your anchors to propose first launch, automation, delivery, bagging, and a bridge blister range.</li>
                      <li>The <strong>Bill new Rx</strong> tab uses your rule: days supply = days from today to the next launch Sunday; quantity covers until the CPAK blister with the change is ready (launch + 14 days).</li>
                    </ul>
                  </li>
                </ul>
              </div>
            </div>

            <!-- 9. How to use this tool with the guide -->
            <div class="accordion-item" data-id="9">
              <div class="accordion-header"><div class="accordion-title">9. How to use this tool with the full Guide</div><div class="accordion-caret">‚ñ∂</div></div>
              <div class="accordion-panel">
                <p style="margin:4px 0 6px;">Think of the PDF as the ‚Äútextbook‚Äù and this tab as your ‚Äúlecture slides‚Äù. The Schedule, New patient, and Bill new Rx tabs are your calculators.</p>
                <ul>
                  <li><strong>Before Sunday:</strong> use the <strong>Schedule</strong> tab to confirm which batches will launch and when to send automation.</li>
                  <li><strong>On Sunday:</strong> after launching, check the dashboard and calendar to see how this cycle plays out.</li>
                  <li><strong>When adding a new patient:</strong> run the <strong>New blister patient wizard</strong>, then follow Section 5 of the guide for setup and MAR.</li>
                  <li><strong>When a new Rx / dose change arrives mid-cycle:</strong> use the <strong>Bill new Rx (bridge)</strong> tab to calculate quantity, days supply, and a note.</li>
                  <li><strong>Training new staff:</strong> walk them through this Training tab in order while showing the PDF.</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- TAB: Quick Links Hub -->
      <div id="tab-quick-links" class="tab-content">
        <div class="section-title">Quick Links Hub</div>
        <div class="small">
          One place for the key tools you use around blister packs. All links open in a new tab.
        </div>

        <div class="links-card">
          <div class="links-title">External tools & references</div>

          <div class="links-grid">
            <!-- ISP link -->
            <div class="links-subcard">
              <div class="links-subtitle">ISP ‚Äì Pre-Verification Batch Report</div>
              <a
                class="quick-link"
                href="http://isp:6777/login"
                target="_blank"
                rel="noopener noreferrer"
              >
                <span>üîó</span>
                <span>Open ISP login</span>
              </a>
              <div class="quick-link-desc">
                Use this after launching a batch to run the ISP report: confirm billing, identify
                non-DSP products, and spot patients paying too much. Only works on the pharmacy
                network.
              </div>
              <div class="quick-link-pill" style="margin-top: 6px;">
                <span>üí°</span>
                <span>Tip: run it same day as launch</span>
              </div>
            </div>

            <!-- ODB e-formulary -->
            <div class="links-subcard">
              <div class="links-subtitle">ODB e-Formulary</div>
              <a
                class="quick-link"
                href="https://www.formulary.health.gov.on.ca/formulary/"
                target="_blank"
                rel="noopener noreferrer"
              >
                <span>üìò</span>
                <span>Open ODB e-Formulary</span>
              </a>
              <div class="quick-link-desc">
                Official Ontario Drug Benefit e-formulary. Use it alongside CPAK‚Äôs DSP list when
                you‚Äôre switching products or confirming coverage for blister-pack patients.
              </div>
              <div class="quick-link-pill" style="margin-top: 6px;">
                <span>üîç</span>
                <span>Search by DIN / generic / brand</span>
              </div>
            </div>

            <!-- CPAK Formulary -->
            <div class="links-subcard">
              <div class="links-subtitle">CPAK Formulary (SharePoint)</div>
              <a
                class="quick-link"
                href="https://mtcad.sharepoint.com/:x:/s/EBG/ESeCNXBAdXlFp0SA8sHL7hEBKruMM2KBFVwKOpCS_JHx2w?CID=74fa29ef-1c4f-f46b-b775-3f481b82a598&e=suAtca"
                target="_blank"
                rel="noopener noreferrer"
              >
                <span>üìÇ</span>
                <span>Open CPAK formulary</span>
              </a>
              <div class="quick-link-desc">
                Shared Services CPAK formulary on SharePoint. Use it to confirm CPAK-approved DSP
                products and align with what can be packed in blisters.
              </div>
              <div class="quick-link-pill" style="margin-top: 6px;">
                <span>üíä</span>
                <span>DSP & packable list</span>
              </div>
            </div>

            <!-- Frequent dispensing form -->
            <div class="links-subcard">
              <div class="links-subtitle">Frequent Dispensing Form (ODB)</div>
              <a
                class="quick-link"
                href="https://assets.ctfassets.net/6duvppog4mpx/4y03tYQV7zBZm6Qam8jcTZ/2226a639097cb30bddfed519103cd072/Frequent_Dispensing_Form.pdf"
                target="_blank"
                rel="noopener noreferrer"
              >
                <span>üìù</span>
                <span>Open ODB Frequent Dispensing Form (PDF)</span>
              </a>
              <div class="quick-link-desc">
                Print, complete, and fax to the prescriber when a patient qualifies for frequent
                dispensing (e.g., blister packs). File signed copies according to your store‚Äôs
                policy and the Blister Pack Guide.
              </div>
              <div class="quick-link-pill" style="margin-top: 6px;">
                <span>üñ®Ô∏è</span>
                <span>Print & keep near MAR binders</span>
              </div>
            </div>

            <!-- Blister Pack Training Guide (Google Doc) -->
            <div class="links-subcard">
              <div class="links-subtitle">Blister Pack Training Guide (Google Doc)</div>
              <a
                class="quick-link"
                href="https://docs.google.com/document/d/1lcmdu-bw4nqMBfQ5u6CtB1IN3CyQ9Bgv/edit?usp=sharing&amp;ouid=115543479751509479212&amp;rtpof=true&amp;sd=true"
                target="_blank"
                rel="noopener noreferrer"
              >
                <span>üß≠</span>
                <span>Open Training Guide</span>
              </a>
              <div class="quick-link-desc">
                Your full A‚ÄìZ blister workflow guide (setup ‚Üí bagging). Use it alongside the Training tab.
              </div>
              <div class="quick-link-pill" style="margin-top: 6px;">
                <span>üìé</span>
                <span>Always current</span>
              </div>
            </div>

          </div>
        </div>
      </div>
      <!-- END tabs -->

    </div>
  </div>

  <script>
    // ---- CONFIG (anchors & rules) ----
    const WEEKLY_TARGET_WEEKDAY = 0; // Sunday
    const BIWEEKLY_ANCHOR = new Date(2025, 10, 23); BIWEEKLY_ANCHOR.setHours(0, 0, 0, 0); // Nov 23, 2025
    const MONTHLY_ANCHOR  = new Date(2025, 10, 16); MONTHLY_ANCHOR.setHours(0, 0, 0, 0); // Nov 16, 2025
    const BIWEEKLY_INTERVAL = 14; // days
    const MONTHLY_INTERVAL  = 28; // days

    // For main calendar
    let currentMonthDate = null; // first day of visible month
    let calendarEventsMap = {};  // { "yyyy-mm-dd": [ { type, label, dotClass } ] }

    const EVENT_TYPES = {
      weeklyLaunch:       { label: "Weekly batch launch",              dotClass: "dot-weekly-launch" },
      biweeklyLaunch:     { label: "Bi-weekly batch launch",           dotClass: "dot-bi-launch" },
      monthlyLaunch:      { label: "28-day ‚Äúmonthly‚Äù batch launch",    dotClass: "dot-monthly-launch" },
      weeklyAutomation:   { label: "Weekly batch automation",          dotClass: "dot-automation" },
      biweeklyAutomation: { label: "Bi-weekly batch automation",       dotClass: "dot-automation" },
      monthlyAutomation:  { label: "Monthly batch automation",         dotClass: "dot-automation" },
      weeklyDelivery:     { label: "Weekly batch delivery",            dotClass: "dot-delivery" },
      biweeklyDelivery:   { label: "Bi-weekly batch delivery",         dotClass: "dot-delivery" },
      monthlyDelivery:    { label: "Monthly batch delivery",           dotClass: "dot-delivery" }
    };

    // Wizard batch config
    const WIZARD_BATCH_CONFIG = {
      "tue-weekly": { label: "Weekly ‚Äì Tuesday batch",  binder: "Tuesday SS-CPAK-7 binder" },
      "wed-weekly": { label: "Weekly ‚Äì Wednesday batch", binder: "Wednesday SS-CPAK-7 binder" },
      "biweekly":   { label: "Bi-weekly batch",          binder: "Bi-weekly SS-CPAK-7 binder" },
      "monthly":    { label: "28-day ‚Äúmonthly‚Äù batch",   binder: "Monthly SS-CPAK-7 binder" }
    };

    // ---- DATE UTILITIES ----
    function parseLocalDate(input) {
      if (!input) return null;
      const parts = input.split("-");
      if (parts.length !== 3) return null;
      const year = Number(parts[0]);
      const month = Number(parts[1]);
      const day = Number(parts[2]);
      if (!year || !month || !day) return null;
      const d = new Date(year, month - 1, day);
      d.setHours(0, 0, 0, 0);
      return d;
    }

    function formatDateYMD(date) {
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, "0");
      const d = String(date.getDate()).padStart(2, "0");
      return `${y}-${m}-${d}`;
    }

    function formatNiceDate(date) {
      return date.toLocaleDateString(undefined, { weekday: "short", year: "numeric", month: "short", day: "numeric" });
    }

    function formatNiceDateNoWeekday(date) {
      return date.toLocaleDateString(undefined, { year: "numeric", month: "short", day: "numeric" });
    }

    function getDayName(date) { return date.toLocaleDateString(undefined, { weekday: "long" }); }

    function addDays(date, days) { const d = new Date(date); d.setDate(d.getDate() + days); return d; }
    function diffInDays(a, b) { const msPerDay = 24 * 60 * 60 * 1000; return Math.round((b - a) / msPerDay); }
    function isSunday(date) { return date.getDay() === 0; }

    function getNextWeeklyLaunch(today) {
      const todayDow = today.getDay();
      const diff = (7 + WEEKLY_TARGET_WEEKDAY - todayDow) % 7;
      return addDays(today, diff); // diff = 0 ‚Üí launch today
    }

    function getNextCycleLaunch(today, anchor, intervalDays) {
      let next = new Date(anchor);
      while (next < today) { next = addDays(next, intervalDays); }
      return next;
    }

    // ---- THEME ----
    function applyTheme(theme) {
      document.body.setAttribute("data-theme", theme);
      try { localStorage.setItem("batchTheme", theme); } catch (e) {}
      const select = document.getElementById("themeSelect");
      if (select && select.value !== theme) { select.value = theme; }
    }

    function initTheme() {
      let saved = null;
      try { saved = localStorage.getItem("batchTheme"); } catch (e) {}
      // Clamp to supported themes only
      if (saved !== "light" && saved !== "dark") {
        saved = "light";
      }
      const defaultTheme = saved;
      applyTheme(defaultTheme);
      const select = document.getElementById("themeSelect");
      if (select) {
        select.value = defaultTheme;
        select.addEventListener("change", (e) => {
          const next = e.target.value === "dark" ? "dark" : "light";
          applyTheme(next);
        });
      }
    }

    // ---- TABS ----
    function initTabs() {
      const tabButtons = document.querySelectorAll(".tab-btn");
      const tabContents = {
        "schedule": document.getElementById("tab-schedule"),
        "new-patient": document.getElementById("tab-new-patient"),
        "bill-rx": document.getElementById("tab-bill-rx"),
        "training": document.getElementById("tab-training"),
        "quick-links": document.getElementById("tab-quick-links")
      };

      tabButtons.forEach((btn) => {
        btn.addEventListener("click", () => {
          const target = btn.getAttribute("data-tab-target");
          if (!target) return;
          tabButtons.forEach((b) => b.classList.remove("tab-btn--active"));
          btn.classList.add("tab-btn--active");
          Object.keys(tabContents).forEach((key) => {
            const el = tabContents[key];
            if (!el) return;
            el.classList.toggle("tab-content--active", key === target);
          });
        });
      });
    }

    // ---- TODAY INPUT & BUTTON ----
    function setDefaultToday() {
      const todayInput = document.getElementById("todayInput");
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      todayInput.value = formatDateYMD(today);
    }

    function initTodayButton() {
      const todayBtn = document.getElementById("todayBtn");
      const todayInput = document.getElementById("todayInput");
      const calcBtn = document.getElementById("calcBtn");
      if (todayBtn && todayInput && calcBtn) {
        todayBtn.addEventListener("click", () => {
          const today = new Date();
          today.setHours(0, 0, 0, 0);
          todayInput.value = formatDateYMD(today);
          calcBtn.click();
        });
      }
    }

    // ---- CALENDAR EVENTS FOR MAIN CALENDAR ----
    function addEventToMap(dateKey, type) {
      if (!EVENT_TYPES[type]) return;
      if (!calendarEventsMap[dateKey]) { calendarEventsMap[dateKey] = []; }
      calendarEventsMap[dateKey].push({ type, label: EVENT_TYPES[type].label, dotClass: EVENT_TYPES[type].dotClass });
    }

    function buildCalendarEvents(start, end) {
      calendarEventsMap = {};
      const searchStart = addDays(start, -14);
      const searchEnd = addDays(end, 14);

      // Weekly events
      let d = new Date(searchStart); d.setHours(0, 0, 0, 0);
      while (d.getDay() !== WEEKLY_TARGET_WEEKDAY) { d = addDays(d, 1); }
      while (d <= searchEnd) {
        const launch = new Date(d);
        const automation = addDays(launch, 3); // Wed
        const delivery = addDays(launch, 8);   // Mon
        const launchKey = formatDateYMD(launch);
        const autoKey = formatDateYMD(automation);
        const delKey = formatDateYMD(delivery);
        if (launch >= start && launch <= end) addEventToMap(launchKey, "weeklyLaunch");
        if (automation >= start && automation <= end) addEventToMap(autoKey, "weeklyAutomation");
        if (delivery >= start && delivery <= end) addEventToMap(delKey, "weeklyDelivery");
        d = addDays(d, 7);
      }

      // Bi-weekly events
      let bi = new Date(BIWEEKLY_ANCHOR); bi.setHours(0, 0, 0, 0);
      while (bi <= searchEnd) {
        const launch = new Date(bi);
        const automation = addDays(launch, 3);
        const delivery = addDays(launch, 8);
        const launchKey = formatDateYMD(launch);
        const autoKey = formatDateYMD(automation);
        const delKey = formatDateYMD(delivery);
        if (launch >= start && launch <= end) addEventToMap(launchKey, "biweeklyLaunch");
        if (automation >= start && automation <= end) addEventToMap(autoKey, "biweeklyAutomation");
        if (delivery >= start && delivery <= end) addEventToMap(delKey, "biweeklyDelivery");
        bi = addDays(bi, BIWEEKLY_INTERVAL);
      }

      // Monthly (28-day) events
      let mo = new Date(MONTHLY_ANCHOR); mo.setHours(0, 0, 0, 0);
      while (mo <= searchEnd) {
        const launch = new Date(mo);
        const automation = addDays(launch, 3);
        const delivery = addDays(launch, 8);
        const launchKey = formatDateYMD(launch);
        const autoKey = formatDateYMD(automation);
        const delKey = formatDateYMD(delivery);
        if (launch >= start && launch <= end) addEventToMap(launchKey, "monthlyLaunch");
        if (automation >= start && automation <= end) addEventToMap(autoKey, "monthlyAutomation");
        if (delivery >= start && delivery <= end) addEventToMap(delKey, "monthlyDelivery");
        mo = addDays(mo, MONTHLY_INTERVAL);
      }
    }

    function renderCalendar() {
      const monthLabelEl = document.getElementById("calendarMonthLabel");
      const tbody = document.getElementById("calendarBody");
      const today = new Date(); today.setHours(0, 0, 0, 0);
      const todayKey = formatDateYMD(today);

      const year = currentMonthDate.getFullYear();
      const month = currentMonthDate.getMonth();

      monthLabelEl.textContent = currentMonthDate.toLocaleDateString(undefined, { month: "long", year: "numeric" });

      const firstOfMonth = new Date(year, month, 1);
      const lastOfMonth = new Date(year, month + 1, 0);
      firstOfMonth.setHours(0, 0, 0, 0);
      lastOfMonth.setHours(0, 0, 0, 0);

      const gridStart = new Date(firstOfMonth);
      while (gridStart.getDay() !== 0) { gridStart.setDate(gridStart.getDate() - 1); }
      const gridEnd = new Date(gridStart);
      gridEnd.setDate(gridEnd.getDate() + 6 * 7 - 1);
      gridEnd.setHours(0, 0, 0, 0);

      buildCalendarEvents(gridStart, gridEnd);
      tbody.innerHTML = "";

      let current = new Date(gridStart);
      let defaultSelectedKey = todayKey;
      if (today < firstOfMonth || today > lastOfMonth) { defaultSelectedKey = formatDateYMD(firstOfMonth); }

      for (let week = 0; week < 6; week++) {
        const tr = document.createElement("tr");
        for (let dow = 0; dow < 7; dow++) {
          const td = document.createElement("td");
          const cellDate = new Date(current);
          const cellKey = formatDateYMD(cellDate);
          const cellMonth = cellDate.getMonth();

          const cellDiv = document.createElement("div");
          cellDiv.classList.add("calendar-cell");
          if (cellMonth !== month) { cellDiv.classList.add("calendar-cell--other"); }
          if (cellKey === todayKey) { cellDiv.classList.add("calendar-cell--today"); }
          cellDiv.dataset.dateKey = cellKey;

          const dayNumber = document.createElement("div");
          dayNumber.classList.add("calendar-day-number");
          dayNumber.textContent = cellDate.getDate();

          const dotsDiv = document.createElement("div");
          dotsDiv.classList.add("calendar-dots");

          const events = calendarEventsMap[cellKey] || [];
          const usedTypes = new Set();
          events.forEach((ev) => {
            if (usedTypes.has(ev.type)) return;
            usedTypes.add(ev.type);
            const dot = document.createElement("span");
            dot.classList.add("calendar-dot");
            if (ev.dotClass) dot.classList.add(ev.dotClass);
            dotsDiv.appendChild(dot);
          });

          cellDiv.appendChild(dayNumber);
          cellDiv.appendChild(dotsDiv);
          cellDiv.addEventListener("click", () => { selectCalendarDate(cellKey); });
          td.appendChild(cellDiv);
          tr.appendChild(td);

          current.setDate(current.getDate() + 1);
        }
        tbody.appendChild(tr);
      }

      selectCalendarDate(defaultSelectedKey);
    }

    function selectCalendarDate(dateKey) {
      const tbody = document.getElementById("calendarBody");
      if (!tbody) return;
      const prevSelected = tbody.querySelector(".calendar-cell--selected");
      if (prevSelected) { prevSelected.classList.remove("calendar-cell--selected"); }

      const cell = tbody.querySelector('[data-date-key="' + dateKey + '"]');
      if (cell) { cell.classList.add("calendar-cell--selected"); }

      const detailsEl = document.getElementById("calendarDetails");
      const titleEl = detailsEl.querySelector(".calendar-details-title");
      const bodyEl = detailsEl.querySelector(".calendar-details-body");

      const parts = dateKey.split("-");
      const year = Number(parts[0]);
      const month = Number(parts[1]);
      const day = Number(parts[2]);
      const dateObj = new Date(year, month - 1, day);

      const niceDate = dateObj.toLocaleDateString(undefined, { weekday: "long", year: "numeric", month: "short", day: "numeric" });
      titleEl.textContent = "Events on " + niceDate;

      const events = calendarEventsMap[dateKey] || [];
      if (!events.length) { bodyEl.textContent = "No launches, automations, or deliveries on this day."; return; }

      let html = "<ul>";
      events.forEach((ev) => { html += "<li>" + ev.label + "</li>"; });
      html += "</ul>";
      bodyEl.innerHTML = html;
    }

    function initCalendar() {
      const now = new Date(); now.setHours(0, 0, 0, 0);
      currentMonthDate = new Date(now.getFullYear(), now.getMonth(), 1);

      const prevBtn = document.getElementById("prevMonthBtn");
      const nextBtn = document.getElementById("nextMonthBtn");

      prevBtn.addEventListener("click", () => {
        currentMonthDate = new Date(currentMonthDate.getFullYear(), currentMonthDate.getMonth() - 1, 1);
        renderCalendar();
      });

      nextBtn.addEventListener("click", () => {
        currentMonthDate = new Date(currentMonthDate.getFullYear(), currentMonthDate.getMonth() + 1, 1);
        renderCalendar();
      });

      renderCalendar();
    }

    // ---- DASHBOARD RENDER ----
    function renderDashboard(batches) {
      const box = document.getElementById("dashboardBox");
      const body = document.getElementById("dashboardBody");
      body.innerHTML = "";

      batches.forEach((batch) => {
        const card = document.createElement("div");
        card.classList.add("dashboard-card");

        const title = document.createElement("div");
        title.classList.add("dashboard-card-title");
        title.textContent = batch.name;
        card.appendChild(title);

        const launchRow = document.createElement("div");
        launchRow.classList.add("dashboard-row");
        launchRow.innerHTML = '<span class="dashboard-label">Next launch</span>' + '<span class="dashboard-value">' + formatNiceDate(batch.nextLaunch) + '</span>';
        card.appendChild(launchRow);

        const autoRow = document.createElement("div");
        autoRow.classList.add("dashboard-row");
        autoRow.innerHTML = '<span class="dashboard-label">Automation</span>' + '<span class="dashboard-value">' + formatNiceDate(batch.automationDate) + '</span>';
        card.appendChild(autoRow);

        const counts = document.createElement("div");
        counts.classList.add("dashboard-count");
        const launchText = batch.daysUntilLaunch === 0 ? "Launch today" : batch.daysUntilLaunch === 1 ? "Launch in 1 day" : "Launch in " + batch.daysUntilLaunch + " days";
        const autoText = batch.daysUntilAutomation === 0 ? "Automation today" : batch.daysUntilAutomation === 1 ? "Automation in 1 day" : "Automation in " + batch.daysUntilAutomation + " days";
        counts.textContent = launchText + " ¬∑ " + autoText;
        card.appendChild(counts);

        body.appendChild(card);
      });

      box.style.display = "block";
    }

    // ---- PATIENT MINI CALENDAR (NEW PATIENT TAB) ----
    function renderPatientCalendar(startDate, launch, automation, delivery, bagging) {
      const card = document.getElementById("wizardCalCard");
      const container = document.getElementById("wizardCalMonthsContainer");
      if (!card || !container) return;

      container.innerHTML = "";

      function sameDay(d1, d2) { return d1.getFullYear() === d2.getFullYear() && d1.getMonth() === d2.getMonth() && d1.getDate() === d2.getDate(); }

      const sameMonth = startDate.getFullYear() === bagging.getFullYear() && startDate.getMonth() === bagging.getMonth();
      const monthsToShow = [];

      if (sameMonth) {
        monthsToShow.push({ label: startDate.toLocaleDateString(undefined, { month: "long", year: "numeric" }), baseDate: new Date(startDate.getFullYear(), startDate.getMonth(), 1) });
      } else {
        monthsToShow.push({ label: startDate.toLocaleDateString(undefined, { month: "long", year: "numeric" }), baseDate: new Date(startDate.getFullYear(), startDate.getMonth(), 1) });
        monthsToShow.push({ label: bagging.toLocaleDateString(undefined, { month: "long", year: "numeric" }), baseDate: new Date(bagging.getFullYear(), bagging.getMonth(), 1) });
      }

      monthsToShow.forEach(({ label, baseDate }) => {
        baseDate.setHours(0, 0, 0, 0);
        const wrapper = document.createElement("div"); wrapper.className = "patient-calendar-wrapper";
        const title = document.createElement("div"); title.className = "patient-calendar-month-label"; title.textContent = label; wrapper.appendChild(title);

        const table = document.createElement("table"); table.className = "patient-calendar";
        const thead = document.createElement("thead"); thead.innerHTML = "<tr><th>Sun</th><th>Mon</th><th>Tue</th><th>Wed</th><th>Thu</th><th>Fri</th><th>Sat</th></tr>"; table.appendChild(thead);
        const tbody = document.createElement("tbody");

        const firstOfMonth = new Date(baseDate.getFullYear(), baseDate.getMonth(), 1); firstOfMonth.setHours(0, 0, 0, 0);
        const gridStart = new Date(firstOfMonth); while (gridStart.getDay() !== 0) { gridStart.setDate(gridStart.getDate() - 1); }
        const monthIndex = baseDate.getMonth(); let current = new Date(gridStart);

        for (let week = 0; week < 6; week++) {
          const tr = document.createElement("tr");
          for (let dow = 0; dow < 7; dow++) {
            const td = document.createElement("td");
            const cellDate = new Date(current);
            const cellDiv = document.createElement("div"); cellDiv.classList.add("patient-calendar-cell");
            if (cellDate.getMonth() !== monthIndex) { cellDiv.classList.add("patient-calendar-cell--other"); }

            const dayNumber = document.createElement("div"); dayNumber.classList.add("patient-calendar-day-number"); dayNumber.textContent = cellDate.getDate();
            const dotsDiv = document.createElement("div"); dotsDiv.classList.add("patient-calendar-dots");

            if (sameDay(cellDate, startDate)) { const dot = document.createElement("span"); dot.classList.add("patient-cal-dot", "patient-cal-dot--start"); dotsDiv.appendChild(dot); }
            if (sameDay(cellDate, launch))    { const dot = document.createElement("span"); dot.classList.add("patient-cal-dot", "patient-cal-dot--launch"); dotsDiv.appendChild(dot); }
            if (sameDay(cellDate, automation)){ const dot = document.createElement("span"); dot.classList.add("patient-cal-dot", "patient-cal-dot--auto"); dotsDiv.appendChild(dot); }
            if (sameDay(cellDate, delivery))  { const dot = document.createElement("span"); dot.classList.add("patient-cal-dot", "patient-cal-dot--delivery"); dotsDiv.appendChild(dot); }
            if (sameDay(cellDate, bagging))   { const dot = document.createElement("span"); dot.classList.add("patient-cal-dot", "patient-cal-dot--bagging"); dotsDiv.appendChild(dot); }

            cellDiv.appendChild(dayNumber);
            cellDiv.appendChild(dotsDiv);
            td.appendChild(cellDiv);
            tr.appendChild(td);
            current.setDate(current.getDate() + 1);
          }
          tbody.appendChild(tr);
        }

        table.appendChild(tbody);
        wrapper.appendChild(table);
        container.appendChild(wrapper);
      });

      card.style.display = "block";
    }

    // ---- WIZARD ----
    function initWizard() {
      const btn = document.getElementById("wizardGenerateBtn");
      if (!btn) return;

      btn.addEventListener("click", () => {
        const batchValue = document.getElementById("wizardBatchType").value;
        const startStr = document.getElementById("wizardStartDate").value;
        const hasSupplyValue = document.getElementById("wizardHasSupply").value;

        const errorBox = document.getElementById("wizardErrorBox");
        const outputBox = document.getElementById("wizardOutputBox");
        const placeholder = document.getElementById("wizardPlaceholder");
        const calCard = document.getElementById("wizardCalCard");

        errorBox.style.display = "none"; errorBox.textContent = "";
        if (calCard) calCard.style.display = "none";

        if (!batchValue || !startStr || !hasSupplyValue) {
          errorBox.textContent = "Please fill out batch type, patient start date, and supply at home.";
          errorBox.style.display = "block";
          outputBox.style.display = "none";
          placeholder.style.display = "block";
          return;
        }

        const batchConfig = WIZARD_BATCH_CONFIG[batchValue];
        if (!batchConfig) {
          errorBox.style.display = "block";
          errorBox.textContent = "Invalid batch type selected.";
          outputBox.style.display = "none";
          placeholder.style.display = "block";
          return;
        }

        const startDate = parseLocalDate(startStr);
        if (!startDate) {
          errorBox.textContent = "Please enter a valid start date.";
          errorBox.style.display = "block";
          outputBox.style.display = "none";
          placeholder.style.display = "block";
          return;
        }

        // Determine first launch based on batch type and anchors
        let nextLaunch;
        if (batchValue === "tue-weekly" || batchValue === "wed-weekly") {
          nextLaunch = getNextWeeklyLaunch(startDate);
        } else if (batchValue === "biweekly") {
          nextLaunch = getNextCycleLaunch(startDate, BIWEEKLY_ANCHOR, BIWEEKLY_INTERVAL);
        } else if (batchValue === "monthly") {
          nextLaunch = getNextCycleLaunch(startDate, MONTHLY_ANCHOR, MONTHLY_INTERVAL);
        } else {
          errorBox.textContent = "Unsupported batch type.";
          errorBox.style.display = "block";
          outputBox.style.display = "none";
          placeholder.style.display = "block";
          return;
        }

        const automation = addDays(nextLaunch, 3);
        const delivery  = addDays(nextLaunch, 8);
        const bagging   = addDays(nextLaunch, 14);

        const hasSupply = hasSupplyValue === "yes";
        let bridgeText  = "No bridge required";
        let bridgeDetail = "";

        if (!hasSupply) {
          const bridgeEnd = bagging;
          const daysCover = diffInDays(startDate, bridgeEnd) + 1; // inclusive
          bridgeText   = `Yes ‚Äì cover from ${formatNiceDateNoWeekday(startDate)} to ${formatNiceDateNoWeekday(bridgeEnd)} (${daysCover} days)`;
          bridgeDetail = `Bridge blister (non-billed) dispensed to cover from ${formatNiceDateNoWeekday(startDate)} until the CPAK blister is bagged and ready for pick-up on ${formatNiceDateNoWeekday(bridgeEnd)}.`;
        }

        document.getElementById("wizardSummaryBatch").textContent      = batchConfig.label;
        document.getElementById("wizardSummaryStartDate").textContent  = formatNiceDateNoWeekday(startDate);
        document.getElementById("wizardSummaryLaunchDate").textContent = formatNiceDate(nextLaunch);
        document.getElementById("wizardSummaryBridge").textContent     = bridgeText;
        document.getElementById("wizardSummaryAutomation").textContent = formatNiceDate(automation);
        document.getElementById("wizardSummaryDelivery").textContent   = formatNiceDate(delivery);
        document.getElementById("wizardSummaryBagging").textContent    = formatNiceDate(bagging);

        const noteLines = [];
        if (!hasSupply) {
          noteLines.push(bridgeDetail);
        } else {
          noteLines.push(
            `Patient has existing supply at home and will transition to CPAK blister cycle starting on ${formatNiceDateNoWeekday(nextLaunch)}.`
          );
        }
        noteLines.push(`Added to Group SS-CPAK-7, ${batchConfig.label}.`);
        noteLines.push("First CPAK cycle:");
        noteLines.push(`- Launch/billing: ${formatNiceDate(nextLaunch)} (Sunday).`);
        noteLines.push(`- Automation: ${formatNiceDate(automation)} (Wednesday, after queues cleared).`);
        noteLines.push(`- CPAK delivery: ${formatNiceDate(delivery)} (Monday).`);
        noteLines.push(`- Bagging/pick-up: ${formatNiceDate(bagging)} (Sunday, after product check).`);

        // FIX: Join with a proper newline character (no stray quote/newline)
        document.getElementById("wizardNoteText").value = noteLines.join("\n");

        // Render patient mini calendar and reveal output
        renderPatientCalendar(startDate, nextLaunch, automation, delivery, bagging);
        placeholder.style.display = "none";
        outputBox.style.display   = "block";
      });
    }

    // ---- SCHEDULE ("Calculate next launch dates") ----
    function initSchedule() {
      const calcBtn  = document.getElementById("calcBtn");
      const errorBox = document.getElementById("errorBox");
      const resultsBox = document.getElementById("resultsBox");
      const tbody = document.getElementById("resultsTableBody");

      if (!calcBtn) return;

      calcBtn.addEventListener("click", () => {
        errorBox.style.display = "none";
        errorBox.textContent = "";
        resultsBox.style.display = "none";
        tbody.innerHTML = "";

        const todayStr = document.getElementById("todayInput").value;
        const today = parseLocalDate(todayStr);
        if (!today) {
          errorBox.textContent = "Please enter a valid value for today‚Äôs date.";
          errorBox.style.display = "block";
          return;
        }

        const batches = [];
        const weeklyNext  = getNextWeeklyLaunch(today);
        batches.push({ name: "Weekly batch", nextLaunch: weeklyNext });
        const biNext      = getNextCycleLaunch(today, BIWEEKLY_ANCHOR, BIWEEKLY_INTERVAL);
        batches.push({ name: "Bi-weekly batch", nextLaunch: biNext });
        const monthlyNext = getNextCycleLaunch(today, MONTHLY_ANCHOR, MONTHLY_INTERVAL);
        batches.push({ name: "28-day ‚Äúmonthly‚Äù batch", nextLaunch: monthlyNext });

        // Enrich with automation + countdowns
        batches.forEach((batch) => {
          const automation = addDays(batch.nextLaunch, 3);
          batch.automationDate = automation;
          batch.daysUntilLaunch = diffInDays(today, batch.nextLaunch);
          batch.daysUntilAutomation = diffInDays(today, automation);
        });

        // Populate table
        batches.forEach((batch) => {
          let statusClass = "status-upcoming";
          let statusText  = "Upcoming";
          if (batch.daysUntilLaunch === 0) { statusClass = "status-today";  statusText = "Launch today"; }
          else if (batch.daysUntilLaunch < 0) { statusClass = "status-past"; statusText = "Already passed"; }

          const tr = document.createElement("tr");
          tr.innerHTML =
            `<td>${batch.name}</td>` +
            `<td>${formatNiceDate(batch.nextLaunch)}</td>` +
            `<td>${getDayName(batch.nextLaunch)}</td>` +
            `<td>${batch.daysUntilLaunch}</td>` +
            `<td><span class="status-pill ${statusClass}">${statusText}</span></td>`;
          tbody.appendChild(tr);
        });

        resultsBox.style.display = "block";
        renderDashboard(batches);
      });
    }

    // ---- BRIDGE TOOL (Bill new Rx tab) ----
    function initBridgeTool() {
      // Grab elements
      const todayInput = document.getElementById("bridgeTodayDate");
      const launchInput = document.getElementById("bridgeNextLaunch");
      const calcBtn = document.getElementById("bridgeCalcBtn");
      const errorBox = document.getElementById("bridgeErrorBox");

      if (!todayInput || !launchInput || !calcBtn || !errorBox) return;

      // Prefill dates: today and coming Sunday
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      todayInput.value = formatDateYMD(today);
      const daysUntilSunday = (7 - today.getDay()) % 7;
      const comingSunday = addDays(today, daysUntilSunday);
      launchInput.value = formatDateYMD(comingSunday);

      // Ensure default for on-hand select is "no"
      const hasOnHandSelect = document.getElementById("bridgeHasOnHand");
      if (hasOnHandSelect && !hasOnHandSelect.value) { hasOnHandSelect.value = "no"; }

      calcBtn.addEventListener("click", () => {
        errorBox.style.display = "none";
        errorBox.textContent = "";

        const batchType   = document.getElementById("bridgeBatchType").value;
        const todayStr    = todayInput.value;
        const launchStr   = launchInput.value;
        const tpdStr      = document.getElementById("bridgeTabsPerDay").value;
        const hasOnHand   = (document.getElementById("bridgeHasOnHand")?.value === 'yes');
        const drugLabelIn = (document.getElementById("bridgeDrugName").value || "").trim();

        const outputBox   = document.getElementById("bridgeOutputBox");

        const todayDate   = parseLocalDate(todayStr);
        const launchDate  = parseLocalDate(launchStr);
        const tabsPerDay  = parseFloat(tpdStr || "0");

        if (!todayDate || !launchDate) {
          errorBox.textContent = "Please enter valid dates for today and the next launch.";
          errorBox.style.display = "block";
          outputBox.innerHTML = "";
          return;
        }
        if (!tabsPerDay || tabsPerDay <= 0) {
          errorBox.textContent = "Please enter a valid number for tablets per day (e.g., 1 for OD, 2 for BID).";
          errorBox.style.display = "block";
          outputBox.innerHTML = "";
          return;
        }
        if (!isSunday(launchDate)) {
          errorBox.textContent = "The next launch date should be a Sunday based on your workflow. You can still calculate, but double-check the date.";
          errorBox.style.display = "block";
        }

        // CPAK blister with this change ready for pickup: launch + 14 days (Sunday ‚Üí Sunday)
        const cpReady = addDays(launchDate, 14);
        let lastBridgeDay;
        let bridgeDays;
        let quantity;

        if (hasOnHand) {
          // Always 3 weeks overlay when a blister is on hand
          bridgeDays = 21;
          lastBridgeDay = addDays(todayDate, 21 - 1); // inclusive display
          quantity = Math.round((tabsPerDay * 21) * 100) / 100;
        } else {
          // Default: cover until CPAK pack with change is ready
          bridgeDays = diffInDays(todayDate, cpReady);
          if (bridgeDays < 0) bridgeDays = 0;
          lastBridgeDay = addDays(cpReady, -1);
          const rawQty = tabsPerDay * bridgeDays;
          quantity = Math.round(rawQty * 100) / 100; // 2 decimals
        }

        // Days supply to bill = days from TODAY ‚Üí NEXT LAUNCH
        let daysSupplyToBill = diffInDays(todayDate, launchDate);
        if (daysSupplyToBill <= 0) daysSupplyToBill = 1; // at least 1 day if same-day

        // Actual days supplied A = quantity / tabsPerDay (rounded to 2 decimals)
        let actualDaysSupply;
        if (hasOnHand) {
          actualDaysSupply = 21;
        } else {
          actualDaysSupply = quantity / tabsPerDay;
          actualDaysSupply = Math.round(actualDaysSupply * 100) / 100;
          if (Math.abs(actualDaysSupply - Math.round(actualDaysSupply)) < 0.01) {
            actualDaysSupply = Math.round(actualDaysSupply);
          }
        }

        const batchLabel =
          batchType === "weekly"   ? "Weekly batch" :
          batchType === "biweekly" ? "Bi-weekly batch" :
          "28-day ‚Äúmonthly‚Äù batch";

        const drugLabel = drugLabelIn || "this medication";

        const noteEndDate = hasOnHand ? formatNiceDateNoWeekday(addDays(todayDate, 21)) : formatNiceDateNoWeekday(cpReady);
        const noteText =
          `Change for ${drugLabel}. Billed ${quantity} tablets for ${daysSupplyToBill} days to align for next launch date (${formatNiceDateNoWeekday(launchDate)}). ` +
          `However, patient was indeed given ${actualDaysSupply} days supply to cover (from ${formatNiceDateNoWeekday(todayDate)} until ${noteEndDate}).`;

        const techHint = `
          <div class="wizard-output-card">
            <div class="wizard-output-title">Technician action</div>
            <div class="small" style="color: var(--muted-strong);">
              <strong>Bill ${quantity} tab(s) for ${daysSupplyToBill} day(s)</strong> in HealthWATCH, but
              <strong>only dispense enough to cover until the patient‚Äôs next pick-up date</strong>.
            </div>
          </div>`;

        const html = `
          <div class="wizard-output-card">
            <div class="wizard-output-title">Bridge summary</div>
            <div class="wizard-output-row"><span class="wizard-output-label">Batch</span><span class="wizard-output-value">${batchLabel}</span></div>
            <div class="wizard-output-row"><span class="wizard-output-label">Today</span><span class="wizard-output-value">${formatNiceDateNoWeekday(todayDate)}</span></div>
            <div class="wizard-output-row"><span class="wizard-output-label">Next launch (Sunday)</span><span class="wizard-output-value">${formatNiceDateNoWeekday(launchDate)}</span></div>
            <div class="wizard-output-row"><span class="wizard-output-label">CPAK with change ready</span><span class="wizard-output-value">${formatNiceDateNoWeekday(cpReady)}</span></div>
            <div class="wizard-output-row"><span class="wizard-output-label">Bridge coverage (calendar)</span><span class="wizard-output-value">${bridgeDays} day(s) (${formatNiceDateNoWeekday(todayDate)} ‚Üí ${formatNiceDateNoWeekday(lastBridgeDay)})</span></div>
            <div class="wizard-output-row"><span class="wizard-output-label">Quantity to bill</span><span class="wizard-output-value">${quantity} tab(s)</span></div>
            <div class="wizard-output-row"><span class="wizard-output-label">Days supply to enter</span><span class="wizard-output-value">${daysSupplyToBill} day(s) (from today until launch)</span></div>
          </div>
          ${techHint}
          <div class="wizard-output-card">
            <div class="wizard-output-title">Suggested supplemental note</div>
            <textarea id="bridgeNoteText" class="wizard-note-textarea">${noteText}</textarea>
            <button type="button" id="bridgeCopyBtn" class="bridge-copy-btn">Copy note</button>
            <div id="bridgeNoteStatus" class="bridge-note-status">You can tweak the wording before copying.</div>
          </div>`;

        outputBox.innerHTML = html;

        const copyBtn = document.getElementById("bridgeCopyBtn");
        const noteTextarea = document.getElementById("bridgeNoteText");
        const statusEl = document.getElementById("bridgeNoteStatus");
        if (copyBtn && noteTextarea && statusEl) {
          copyBtn.addEventListener("click", async () => {
            try { await navigator.clipboard.writeText(noteTextarea.value); statusEl.textContent = "Note copied to clipboard ‚úÖ"; }
            catch (e) { statusEl.textContent = "Unable to auto-copy. You can select and copy manually."; }
          });
        }
      });
    }

    // ---- TRAINING ACCORDION ----
    const ACCORDION_STORAGE_KEY = 'trainingAccordionOpen';
    function initTrainingAccordion() {
      const container = document.getElementById('trainingAccordion');
      if (!container) return;
      let openSet = new Set();
      try { const arr = JSON.parse(localStorage.getItem(ACCORDION_STORAGE_KEY) || '[]'); openSet = new Set(Array.isArray(arr) ? arr : []); } catch (e) {}

      const items = Array.from(container.querySelectorAll('.accordion-item'));
      const persist = () => { try { localStorage.setItem(ACCORDION_STORAGE_KEY, JSON.stringify([...openSet])); } catch (e) {} };

      items.forEach((item) => {
        const id = item.getAttribute('data-id');
        const header = item.querySelector('.accordion-header');
        const panel = item.querySelector('.accordion-panel');
        const shouldOpen = openSet.has(id);
        if (shouldOpen) { item.classList.add('open'); panel.style.display = 'block'; }
        else { item.classList.remove('open'); panel.style.display = 'none'; }

        header.addEventListener('click', () => {
          const isOpen = item.classList.contains('open');
          if (isOpen) { item.classList.remove('open'); panel.style.display = 'none'; openSet.delete(id); }
          else { item.classList.add('open'); panel.style.display = 'block'; openSet.add(id); }
          persist();
        });
      });

      const expandAllBtn = document.getElementById('accExpandAll');
      const collapseAllBtn = document.getElementById('accCollapseAll');
      if (expandAllBtn) {
        expandAllBtn.addEventListener('click', () => {
          items.forEach((item) => { item.classList.add('open'); item.querySelector('.accordion-panel').style.display = 'block'; });
          openSet = new Set(items.map(i => i.getAttribute('data-id')));
          persist();
        });
      }
      if (collapseAllBtn) {
        collapseAllBtn.addEventListener('click', () => {
          items.forEach((item) => { item.classList.remove('open'); item.querySelector('.accordion-panel').style.display = 'none'; });
          openSet = new Set();
          persist();
        });
      }
    }

    // Ensure external links always open even if a parent captures the click
    function initLinkSafety() {
      const openers = document.querySelectorAll('a.quick-link, .results a');
      openers.forEach((a) => {
        a.addEventListener('click', (e) => {
          // Let browser handle it normally. Only intercept if we successfully opened a new tab.
          if (a.target === '_blank') {
            const w = window.open(a.href, '_blank', 'noopener');
            if (w) {
              e.preventDefault(); // only prevent if a new tab actually opened
            }
          }
        });
      });
    }

    // ---- PARTICLE BACKGROUND (Style 2) ----
function initParticles(){
  const canvas = document.getElementById('bgParticles');
  if(!canvas) return;
  const ctx = canvas.getContext('2d');
  let width, height, DPR = Math.min(window.devicePixelRatio||1, 2);
  function resize(){
    width = window.innerWidth; height = window.innerHeight;
    canvas.style.width = width+'px'; canvas.style.height = height+'px';
    canvas.width = Math.floor(width*DPR); canvas.height = Math.floor(height*DPR);
    ctx.setTransform(DPR,0,0,DPR,0,0);
  }
  resize();
  window.addEventListener('resize', resize);

  const area = width * height;
  const base = Math.floor(area / 9000); // denser field
  const count = Math.max(140, Math.min(340, base));
  const particles = Array.from({length:count}, () => ({
    x: Math.random()*width,
    y: Math.random()*height,
    vx: (Math.random()-0.5)*1.05,
    vy: (Math.random()-0.5)*1.05,
    r: Math.random()*1.8 + 0.7,
    hue: (Math.random()*3)|0
  }));
  const linkDist = Math.min(220, Math.max(140, Math.sqrt(width * height) / 8));

  const reduce = window.matchMedia('(prefers-reduced-motion: reduce)');
  let rafId;
  function styles(){
    const cs = getComputedStyle(document.body);
    return {
      p1: cs.getPropertyValue('--particle1') || 'rgba(56,189,248,0.8)',
      p2: cs.getPropertyValue('--particle2') || 'rgba(99,102,241,0.75)',
      p3: cs.getPropertyValue('--particle3') || 'rgba(14,165,233,0.75)',
      line: cs.getPropertyValue('--particleLine') || 'rgba(56,189,248,0.25)'
    };
  }

  function tick(){
    const s = styles();
    ctx.clearRect(0,0,width,height);

    // Draw and move particles
    for(let i=0;i<particles.length;i++){
      const a = particles[i];
      a.x += a.vx; a.y += a.vy;
      if(a.x < -10) a.x = width+10; else if(a.x>width+10) a.x = -10;
      if(a.y < -10) a.y = height+10; else if(a.y>height+10) a.y = -10;

      ctx.beginPath();
      ctx.fillStyle = (a.hue===0?s.p1:(a.hue===1?s.p2:s.p3));
      ctx.arc(a.x,a.y,a.r,0,Math.PI*2);
      ctx.fill();
    }

    // Connections
    ctx.lineWidth = 1;
    for(let i=0;i<particles.length;i++){
      const a = particles[i];
      for(let j=i+1;j<particles.length;j++){
        const b = particles[j];
        const dx=a.x-b.x, dy=a.y-b.y; const d2=dx*dx+dy*dy;
        if(d2 < linkDist*linkDist){
          const alpha = 1 - (Math.sqrt(d2)/linkDist);
          ctx.strokeStyle = s.line;
          ctx.globalAlpha = alpha * 0.9;
          ctx.beginPath(); ctx.moveTo(a.x,a.y); ctx.lineTo(b.x,b.y); ctx.stroke();
          ctx.globalAlpha = 1;
        }
      }
    }

    if(!reduce.matches) rafId = requestAnimationFrame(tick);
  }

  tick();
  // Safari compatibility: addEventListener may not exist on MediaQueryList
  const onPrefChange = () => {
    if(reduce.matches && rafId){ cancelAnimationFrame(rafId); }
    else { tick(); }
  };
  if (typeof reduce.addEventListener === 'function') {
    reduce.addEventListener('change', onPrefChange);
  } else if (typeof reduce.addListener === 'function') {
    reduce.addListener(onPrefChange);
  }
}

// ---- INIT ----
// Initialize theme first so styles are available to other features
initTheme();
try { initParticles(); } catch(e) { /* fail-safe: don't block app */ }
setDefaultToday();
initTodayButton();
initTabs();
initCalendar();
initWizard();
initSchedule();
initBridgeTool();
initTrainingAccordion();
initLinkSafety();
</script>
</body>
</html>
